import 'package:flutter/material.dart';
import 'package:share_plus/share_plus.dart';
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart' as pw;
import 'package:path_provider/path_provider.dart';
import 'dart:io';
import 'package:intl/intl.dart';

class ResultPage extends StatefulWidget {
	const ResultPage({super.key, required this.result, this.input});

  final Map<String, dynamic> result;
  final Map<String, dynamic>? input;

	@override
	State<ResultPage> createState() => _ResultPageState();
}

class _ResultPageState extends State<ResultPage> {

  String _formatCurrency(double amount) {
    return NumberFormat.currency(symbol: 'â‚¦', decimalDigits: 2).format(amount);
  }

  String _formatQuoteText() {
    final input = widget.input ?? {};
    final result = widget.result;
    
    final outfitName = input['outfitName'] ?? 'N/A';
    final category = input['category'] ?? 'N/A';
    final materialsTotal = result['materialsTotal'] ?? 0.0;
    final laborTotal = result['laborTotal'] ?? 0.0;
    final overheadTotal = result['overheadTotal'] ?? 0.0;
    final profitAmount = result['profitAmount'] ?? 0.0;
    final sellingPrice = result['sellingPrice'] ?? 0.0;
    
    final date = DateFormat('yyyy-MM-dd').format(DateTime.now());
    
    String quote = '''
ðŸ“‹ *Tailoring Quote*

*Job Details:*
â€¢ Outfit: $outfitName
â€¢ Category: $category
â€¢ Date: $date

*Cost Breakdown:*
â€¢ Material Cost: ${_formatCurrency(materialsTotal)}
â€¢ Labor + Overhead: ${_formatCurrency(laborTotal + overheadTotal)}
â€¢ Profit (20%): ${_formatCurrency(profitAmount)}

*Suggested Selling Price:*
${_formatCurrency(sellingPrice)}

---
Generated by TailorCalc
''';
    
    return quote;
  }

  Future<File> _generatePDF() async {
    final pdf = pw.Document();
    final input = widget.input ?? {};
    final result = widget.result;
    
    final outfitName = input['outfitName'] ?? 'N/A';
    final category = input['category'] ?? 'N/A';
    final materialsTotal = result['materialsTotal'] ?? 0.0;
    final laborTotal = result['laborTotal'] ?? 0.0;
    final overheadTotal = result['overheadTotal'] ?? 0.0;
    final profitAmount = result['profitAmount'] ?? 0.0;
    final sellingPrice = result['sellingPrice'] ?? 0.0;
    
    final date = DateFormat('yyyy-MM-dd').format(DateTime.now());
    
    pdf.addPage(
      pw.Page(
        pageFormat: PdfPageFormat.a4,
        build: (pw.Context context) {
          return pw.Padding(
            padding: const pw.EdgeInsets.all(40),
            child: pw.Column(
              crossAxisAlignment: pw.CrossAxisAlignment.start,
              children: [
                pw.Text(
                  'Tailoring Quote',
                  style: pw.TextStyle(
                    fontSize: 24,
                    fontWeight: pw.FontWeight.bold,
                  ),
                ),
                pw.SizedBox(height: 30),
                pw.Text(
                  'Job Details',
                  style: pw.TextStyle(
                    fontSize: 18,
                    fontWeight: pw.FontWeight.bold,
                  ),
                ),
                pw.SizedBox(height: 10),
                pw.Text('Outfit: $outfitName'),
                pw.Text('Category: $category'),
                pw.Text('Date: $date'),
                pw.SizedBox(height: 30),
                pw.Text(
                  'Cost Breakdown',
                  style: pw.TextStyle(
                    fontSize: 18,
                    fontWeight: pw.FontWeight.bold,
                  ),
                ),
                pw.SizedBox(height: 10),
                pw.Text('Material Cost: ${_formatCurrency(materialsTotal)}'),
                pw.Text('Labor + Overhead: ${_formatCurrency(laborTotal + overheadTotal)}'),
                pw.Text('Profit (20%): ${_formatCurrency(profitAmount)}'),
                pw.SizedBox(height: 30),
                pw.Divider(),
                pw.SizedBox(height: 10),
                pw.Text(
                  'Suggested Selling Price',
                  style: pw.TextStyle(
                    fontSize: 20,
                    fontWeight: pw.FontWeight.bold,
                  ),
                ),
                pw.Text(
                  _formatCurrency(sellingPrice),
                  style: pw.TextStyle(
                    fontSize: 24,
                    fontWeight: pw.FontWeight.bold,
                  ),
                ),
                pw.Spacer(),
                pw.Text(
                  'Generated by TailorCalc',
                  style: pw.TextStyle(
                    fontSize: 10,
                    fontStyle: pw.FontStyle.italic,
                  ),
                ),
              ],
            ),
          );
        },
      ),
    );

    final output = await getTemporaryDirectory();
    final file = File('${output.path}/quote_${DateTime.now().millisecondsSinceEpoch}.pdf');
    await file.writeAsBytes(await pdf.save());
    return file;
  }

  Future<void> _shareViaWhatsApp() async {
    try {
      final quoteText = _formatQuoteText();
      await Share.share(
        quoteText,
        subject: 'Tailoring Quote',
      );
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Error sharing: $e')),
        );
      }
    }
  }

  Future<void> _shareAsPDF() async {
    try {
      final pdfFile = await _generatePDF();
      await Share.shareXFiles(
        [XFile(pdfFile.path)],
        text: 'Tailoring Quote',
        subject: 'Tailoring Quote',
      );
    } catch (e) {
      if (mounted) {
        ScaffoldMessenger.of(context).showSnackBar(
          SnackBar(content: Text('Error generating PDF: $e')),
        );
      }
    }
  }

  void _showShareOptions() {
    showModalBottomSheet(
      context: context,
      builder: (BuildContext context) {
        return SafeArea(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              ListTile(
                leading: Icon(Icons.message),
                title: Text('Share as WhatsApp Message'),
                onTap: () {
                  Navigator.pop(context);
                  _shareViaWhatsApp();
                },
              ),
              ListTile(
                leading: Icon(Icons.picture_as_pdf),
                title: Text('Share as PDF'),
                onTap: () {
                  Navigator.pop(context);
                  _shareAsPDF();
                },
              ),
              ListTile(
                leading: Icon(Icons.cancel),
                title: Text('Cancel'),
                onTap: () => Navigator.pop(context),
              ),
            ],
          ),
        );
      },
    );
  }

	@override
	Widget build(BuildContext context) {
    final materialsTotal = widget.result['materialsTotal'] ?? 0.0;
    final laborTotal = widget.result['laborTotal'] ?? 0.0;
    final overheadTotal = widget.result['overheadTotal'] ?? 0.0;
    final profitAmount = widget.result['profitAmount'] ?? 0.0;
    final sellingPrice = widget.result['sellingPrice'] ?? 0.0;
    
		return Scaffold(
			appBar: AppBar(
        backgroundColor: Colors.blue,
        foregroundColor: Colors.white,
				title: Text('Calculation Result'),
			),
      body: SafeArea(
        child: ListView(
          padding: const EdgeInsets.all(30.0),
          children: [
            Text('Material Cost'),
            SizedBox(height: 10),
            Text(
              _formatCurrency(materialsTotal),
              style: TextStyle(fontSize: 18),
            ),
            SizedBox(height: 30),
            Text('Labor + Overhead'),
            SizedBox(height: 10),
            Text(
              _formatCurrency(laborTotal + overheadTotal),
              style: TextStyle(fontSize: 18),
            ),
            SizedBox(height: 30),
            Text('Profit (20%)'),
            SizedBox(height: 10),
            Text(
              _formatCurrency(profitAmount),
              style: TextStyle(fontSize: 18),
            ),
            SizedBox(height: 30),
            Text('Suggested Selling Price'),
            SizedBox(height: 10),
            Text(
              _formatCurrency(sellingPrice),
              style: TextStyle(
                fontSize: 30,
                fontWeight: FontWeight.bold,
              ),
            ),
            SizedBox(height: 30),
            MaterialButton(
              color: Colors.blue,
              textColor: Colors.white,
              onPressed: () => {},
              minWidth: 100,
              height: 50,
              child: Text('Save as Template'),
            ),
            SizedBox(height: 30),
            MaterialButton(
              color: Colors.blue,
              textColor: Colors.white,
              onPressed: _showShareOptions,
              minWidth: 100,
              height: 50,
              child: Text('Share Quote'),
            )
          ],
        )
      )
		);
	}
}
